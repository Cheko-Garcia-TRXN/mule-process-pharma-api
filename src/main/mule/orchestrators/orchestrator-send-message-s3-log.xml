<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="orchestrator-send-message-s3-main" doc:id="474ae853-b3cf-43a3-9b49-a9b01f54d14b" >
		<ee:transform doc:name="set S3 Variables" doc:id="e35664d6-d186-43cc-9e8d-9765fc17873e" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
import * from dw::core::Binaries
output application/json
---
{
   "api":"process-pharma-api",
   "message_type":vars.message_type,
   "s3": p('client.aws.s3.bucket.files.utils.fwk'),
   "correlation_id":correlationId,
   "logger": true,
   "created_pk": now() as String {format: "uuuuMM"},
   "timestamp": now() as String {format: "uuuuMMddKKmmssSS"},
   "identifier": vars.folder_name ++ "/created_pk="++ now() as String {format: "uuuuMM"} ++ "/created_pk="++ now() as String {format: "uuuuMMdd"} ++ "/" ++ (vars.doc_s3_name default "NO_PROVIDER")  ++ vars.ext,   
   "key": vars.folder_name ++ "/created_pk="++ now() as String {format: "uuuuMM"} ++ "/created_pk="++ now() as String {format: "uuuuMMdd"} ++ "/" ++ (vars.doc_s3_name default "NO_PROVIDER") ++ vars.ext,
   "message": toBase64(write(vars.message_s3, "application/csv"))
   
}
 ]]></ee:set-payload>
			</ee:message>
			<ee:variables />
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="8ae4bf3a-9d94-45dc-b1f0-a7220befe836" message="#[payload]"/>
		<flow-ref doc:name="client-s3-log-request" doc:id="47733840-aef8-43fc-9143-d2729454cc69" name="client-s3-log-request" />
	</sub-flow>
	<sub-flow name="orchestrators-post-s3" doc:id="80b9a823-9c45-4e81-b5fd-9843e7b8352f" >
		<async doc:name="Async" doc:id="0762a9fa-3d9d-4178-ba57-40bafbc0ae6d" >
			<try doc:name="Try" doc:id="f1ca4ec7-cd9c-461e-b133-3980d31b853c">
			<scatter-gather doc:name="Scatter-Gather" doc:id="b1effecd-4833-4a8a-9c7f-4094085c7623" >
					<route >
						<set-payload value="#[%dw 2.0&#10;output application/json&#10;ns ns2 http://ws.edifactwstraxion/&#10;---&#10;{&#10;    &quot;api&quot;: &quot;process-pharma&quot;,&#10;    &quot;message_type&quot;: &quot;utils-fwk-stream-request&quot;,&#10;    &quot;s3&quot;: p('client.aws.s3.bucket.cartaporte.documents'),&#10;    &quot;correlation_id&quot;: correlationId,&#10;    &quot;logger&quot;: true,&#10;    &quot;created_pk&quot;: now() as String {format: &quot;uuuuMM&quot;},&#10;    &quot;timestamp&quot;: now() as String {format: &quot;uuuuMMddKKmmssSS&quot;},&#10;    &quot;identifier&quot;: &quot;api=medistik/created_pk=&quot;++ now() as String {format: &quot;uuuuMM&quot;} ++ &quot;/&quot; ++ vars.originalPayload.traxion.identificador_pedido ++ &quot;_&quot; ++ now() as String {format: &quot;uuuuMMddKKmmssSS&quot;} ++ &quot;-PDF.pdf&quot;,&#10;    &quot;key&quot;: &quot;api=medistik/created_pk=&quot;++ now() as String {format: &quot;uuuuMM&quot;} ++ &quot;/&quot; ++ vars.originalPayload.traxion.identificador_pedido ++ &quot;_&quot; ++ now() as String {format: &quot;uuuuMMddKKmmssSS&quot;} ++ &quot;-PDF.txt&quot;,&#10;    &quot;message&quot;: vars.cpResponse.body.ns2#generaComprobanteResponse.return.documentopdf default &quot;Error&quot;&#10;}]" doc:name="Set S3 PDF Request" doc:id="b7ebc8c3-74cd-4f69-b625-65d98e2eb5b0" />
						<logger level="INFO" doc:name="Logger" doc:id="8eb2c222-caf5-4eeb-8a3c-bf93dbc2ef55" message="#[payload]"/>
						<flow-ref doc:name="Call to client-utils-fwk-stream-call-service-file" doc:id="84b48e85-2eec-4118-b1cd-de6e61f2017e" name="client-utils-fwk-stream-call-service-file" />
					</route>
					<route >
						<set-payload value="#[%dw 2.0&#10;output application/json&#10;ns ns2 http://ws.edifactwstraxion/&#10;---&#10;{&#10;    &quot;api&quot;: &quot;process-pharma&quot;,&#10;    &quot;message_type&quot;: &quot;utils-fwk-stream-request&quot;,&#10;    &quot;s3&quot;: p('client.aws.s3.bucket.cartaporte.documents'),&#10;    &quot;correlation_id&quot;: correlationId,&#10;    &quot;logger&quot;: true,&#10;    &quot;created_pk&quot;: now() as String {format: &quot;uuuuMM&quot;},&#10;    &quot;timestamp&quot;: now() as String {format: &quot;uuuuMMddKKmmssSS&quot;},&#10;    &quot;identifier&quot;: &quot;api=medistik/created_pk=&quot;++ now() as String {format: &quot;uuuuMM&quot;} ++ &quot;/&quot; ++ vars.originalPayload.traxion.identificador_pedido ++ &quot;_&quot; ++ now() as String {format: &quot;uuuuMMddKKmmssSS&quot;} ++ &quot;-XML.xml&quot;,&#10;    &quot;key&quot;: &quot;api=medistik/created_pk=&quot;++ now() as String {format: &quot;uuuuMM&quot;} ++ &quot;/&quot; ++ vars.originalPayload.traxion.identificador_pedido ++ &quot;_&quot; ++ now() as String {format: &quot;uuuuMMddKKmmssSS&quot;} ++ &quot;-XML.txt&quot;,&#10;    &quot;message&quot;: vars.cpResponse.body.ns2#generaComprobanteResponse.return.documentoxml default &quot;Error&quot; &#10;}]" doc:name="Set S3 XML Request" doc:id="1820ad51-fff0-4753-b3ba-0f37d722e10d" />
						<logger level="INFO" doc:name="Logger" doc:id="e120acd5-7df3-4032-90ec-a1f8f68b7fa6" message="#[payload]"/>
						<flow-ref doc:name="Call to client-utils-fwk-stream-call-service-file" doc:id="1d27d6d1-5731-4e6d-b452-13d2721ede8b" name="client-utils-fwk-stream-call-service-file" />
					</route>
				</scatter-gather>
				<error-handler>
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="051d7be1-f91c-4395-a056-d3a7028ea30e" type="ANY">
					<logger level="INFO" doc:name="Error" doc:id="072eb885-705c-455a-8990-4911217a9315" />
				</on-error-continue>
			</error-handler>
		</try>
		</async>
	</sub-flow>	
</mule>
